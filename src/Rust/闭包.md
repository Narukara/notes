## 闭包

#### 定义

```rust
fn  add_one_v1   (x: u32) -> u32 { x + 1 }	// 函数
let add_one_v2 = |x: u32| -> u32 { x + 1 };	// 闭包
let add_one_v3 = |x|             { x + 1 };
let add_one_v4 = |x|               x + 1  ;
```

闭包一般不需要注明参数和返回值类型，编译器会自动推断。如果闭包函数体只有一行，可以不加大括号

与函数类似，允许在参数位置上使用模式匹配

#### 捕获

闭包可以捕获其所在环境中的变量。有三种捕获形式：

1. 获取不可变引用
2. 获取可变引用
3. 获取所有权

编译器会根据闭包内的情况自动分析每个变量的捕获形式。在参数列表前添加 `move` 关键字可以强制获取所有权

#### 类型和 trait

每个闭包都具有独有的类型，即使他们的签名一样，类型也不同。闭包（包括普通函数）都实现了 `Fn` 系列的 trait。`Fn` 系列的 trait 包括 `Fn`、`FnMut`、`FnOnce`。

1. 如果闭包以获取所有权的方式捕获了环境中的值，则其只能被调用一次，实现 `FnOnce`。
2. 如果闭包获取可变引用，则其实现 `FnMut` 和 `FnOnce`。
3. 如果闭包获取不可变引用或者不捕获变量，则其实现 `Fn`、`FnMut`、`FnOnce`。
4. 如果闭包没有捕获任何变量，则其类型可以转为函数指针 `fn`，这样的闭包之间可以有相同的类型

注意：`move` 关键字不会影响闭包实现了什么 `trait`

`Fn` 系列的 trait 带有泛型参数，写法比较特别，例如 `Fn(i32) -> i32`：

```rust
fn exe<T>(f: T, x: i32) -> i32
where
    T: Fn(i32) -> i32,
{
    f(x)
}
```

---

## 高级特性

#### 返回闭包

1. 直接返回闭包

```rust
fn foo1(a: i32) -> impl Fn(i32) -> i32 {
    move |x| x + a
}

fn foo2(b: bool) -> impl Fn(i32) -> i32 {	// 也可以换成 fn(i32) -> i32
    if b {
        |x| x + 1	// 没有捕获变量，可以转为函数指针，因此可以在不同的分支里返回不同的闭包
    } else {
        |x| x + 2
    }
}
```

2. 使用 trait 对象

```rust
fn returns_closure() -> Box<dyn Fn(i32) -> i32> {
    Box::new(|x| x + 1)
}
```

